<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-|
Module    : Database.Orville.Internal.MigrateSchema
Copyright : Flipstone Technology Partners 2016-2018
License   : MIT
-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE DeriveDataTypeable #-}</span><span>
</span><a name="line-7"></a><span>
</span><a name="line-8"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">Orville</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">MigrateSchema</span><span>
</span><a name="line-9"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="Database.Orville.Internal.MigrateSchema.html#migrateSchema"><span class="hs-identifier hs-var">migrateSchema</span></a><span>
</span><a name="line-10"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Database.Orville.Internal.MigrateSchema.html#generateMigrationPlan"><span class="hs-identifier hs-var">generateMigrationPlan</span></a><span>
</span><a name="line-11"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">threadDelay</span><span class="hs-special">)</span><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Exception</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Exc</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Catch</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">IO</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Int</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Monoid</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">String</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">HDBC</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">withTransaction</span><span class="hs-special">)</span><span>
</span><a name="line-22"></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.Internal.Execute.html"><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">Orville</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">Execute</span></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.Internal.Expr.html"><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">Orville</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">Expr</span></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.Internal.FromClause.html"><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">Orville</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">FromClause</span></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.Internal.FromSql.html"><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">Orville</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">FromSql</span></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.Internal.MigrateConstraint.html"><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">Orville</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">MigrateConstraint</span></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.Internal.MigrateIndex.html"><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">Orville</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">MigrateIndex</span></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.Internal.MigrateTable.html"><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">Orville</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">MigrateTable</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.Internal.MigrationError.html"><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">Orville</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">MigrationError</span></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.Internal.MigrationPlan.html"><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">Orville</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">MigrationPlan</span></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.Internal.Monad.html"><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">Orville</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.Internal.SchemaState.html"><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">Orville</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">SchemaState</span></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.Internal.Select.html"><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">Orville</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">Select</span></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.Internal.Types.html"><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">Orville</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.Raw.html"><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">Orville</span><span class="hs-operator">.</span><span class="hs-identifier">Raw</span></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><a href="Database.Orville.Select.html"><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">Orville</span><span class="hs-operator">.</span><span class="hs-identifier">Select</span></a><span>
</span><a name="line-38"></a><span>
</span><a name="line-39"></a><span class="hs-identifier">orvilleLockScope</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int32</span><span>
</span><a name="line-40"></a><a name="orvilleLockScope"><a href="Database.Orville.Internal.MigrateSchema.html#orvilleLockScope"><span class="hs-identifier">orvilleLockScope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">17772</span><span>
</span><a name="line-41"></a><span>
</span><a name="line-42"></a><span class="hs-identifier">migrationLockId</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int32</span><span>
</span><a name="line-43"></a><a name="migrationLockId"><a href="Database.Orville.Internal.MigrateSchema.html#migrationLockId"><span class="hs-identifier">migrationLockId</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">7995632</span><span>
</span><a name="line-44"></a><span>
</span><a name="line-45"></a><span class="hs-identifier">tryLockExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.Internal.Expr.SelectExpr.html#SelectExpr"><span class="hs-identifier hs-type">SelectExpr</span></a><span>
</span><a name="line-46"></a><a name="tryLockExpr"><a href="Database.Orville.Internal.MigrateSchema.html#tryLockExpr"><span class="hs-identifier">tryLockExpr</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-47"></a><span>  </span><a href="Database.Orville.Internal.Expr.Expr.html#rawSqlExpr"><span class="hs-identifier hs-var">rawSqlExpr</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-48"></a><span>  </span><span class="hs-string">&quot;pg_try_advisory_xact_lock(&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">fromString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="Database.Orville.Internal.MigrateSchema.html#orvilleLockScope"><span class="hs-identifier hs-var">orvilleLockScope</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-string">&quot;,&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-49"></a><span>  </span><span class="hs-identifier hs-var">fromString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="Database.Orville.Internal.MigrateSchema.html#migrationLockId"><span class="hs-identifier hs-var">migrationLockId</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-50"></a><span>  </span><span class="hs-string">&quot;) as result&quot;</span><span>
</span><a name="line-51"></a><span>
</span><a name="line-52"></a><span class="hs-identifier">waitForLockExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.Internal.Expr.SelectExpr.html#SelectExpr"><span class="hs-identifier hs-type">SelectExpr</span></a><span>
</span><a name="line-53"></a><a name="waitForLockExpr"><a href="Database.Orville.Internal.MigrateSchema.html#waitForLockExpr"><span class="hs-identifier">waitForLockExpr</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-54"></a><span>  </span><a href="Database.Orville.Internal.Expr.Expr.html#rawSqlExpr"><span class="hs-identifier hs-var">rawSqlExpr</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-55"></a><span>  </span><span class="hs-string">&quot;pg_advisory_xact_lock(&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">fromString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="Database.Orville.Internal.MigrateSchema.html#orvilleLockScope"><span class="hs-identifier hs-var">orvilleLockScope</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-string">&quot;,&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-56"></a><span>  </span><span class="hs-identifier hs-var">fromString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="Database.Orville.Internal.MigrateSchema.html#migrationLockId"><span class="hs-identifier hs-var">migrationLockId</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-57"></a><span>  </span><span class="hs-string">&quot;) as result&quot;</span><span>
</span><a name="line-58"></a><span>
</span><a name="line-59"></a><span class="hs-identifier">lockResult</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.Internal.Types.html#FromSql"><span class="hs-identifier hs-type">FromSql</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-60"></a><a name="lockResult"><a href="Database.Orville.Internal.MigrateSchema.html#lockResult"><span class="hs-identifier">lockResult</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Database.Orville.Internal.FromSql.html#col"><span class="hs-identifier hs-var">col</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;result&quot;</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span>
</span><a name="line-61"></a><span>
</span><a name="line-62"></a><span class="hs-identifier">withLockedTransaction</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.Internal.Monad.html#MonadOrville"><span class="hs-identifier hs-type">MonadOrville</span></a><span> </span><a href="#local-6989586621679104704"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679104705"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadThrow</span><span> </span><a href="#local-6989586621679104705"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679104705"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679104706"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679104705"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679104706"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-63"></a><a name="withLockedTransaction"><a href="Database.Orville.Internal.MigrateSchema.html#withLockedTransaction"><span class="hs-identifier">withLockedTransaction</span></a></a><span> </span><a name="local-6989586621679104707"><a href="#local-6989586621679104707"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-64"></a><span>  </span><a href="#local-6989586621679104708"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-65"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-66"></a><span>    </span><a name="local-6989586621679104708"><a href="#local-6989586621679104708"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621679104710"><a href="#local-6989586621679104710"><span class="hs-identifier">attempts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-67"></a><span>      </span><a name="local-6989586621679104711"><a href="#local-6989586621679104711"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679104709"><span class="hs-identifier hs-var">runWithTransaction</span></a><span>
</span><a name="line-68"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679104711"><span class="hs-identifier hs-var">result</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-69"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679104712"><a href="#local-6989586621679104712"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679104712"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-70"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-71"></a><span>          </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679104710"><span class="hs-identifier hs-var">attempts</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-number">25</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-72"></a><span>            </span><span class="hs-identifier hs-var">throwM</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-73"></a><span>              </span><a href="Database.Orville.Internal.MigrationError.html#MigrationLockExcessiveRetryError"><span class="hs-identifier hs-var">MigrationLockExcessiveRetryError</span></a><span>
</span><a name="line-74"></a><span>                </span><span class="hs-string">&quot;Giving up after 25 attempts to aquire the migration lock.&quot;</span><span>
</span><a name="line-75"></a><span>          </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">threadDelay</span><span> </span><span class="hs-number">10000</span><span>
</span><a name="line-76"></a><span>          </span><a href="#local-6989586621679104708"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679104710"><span class="hs-identifier hs-var">attempts</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-77"></a><span>    </span><a name="local-6989586621679104709"><a href="#local-6989586621679104709"><span class="hs-identifier">runWithTransaction</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-78"></a><span>      </span><a href="Database.Orville.Raw.html#withTransaction"><span class="hs-identifier hs-var">withTransaction</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-79"></a><span>        </span><span class="hs-special">[</span><a name="local-6989586621679104750"><a href="#local-6989586621679104750"><span class="hs-identifier">locked</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-80"></a><span>          </span><a href="Database.Orville.Select.html#runSelect"><span class="hs-identifier hs-var">runSelect</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-81"></a><span>          </span><a href="Database.Orville.Internal.Select.html#selectQueryColumns"><span class="hs-identifier hs-var">selectQueryColumns</span></a><span> </span><span class="hs-special">[</span><a href="Database.Orville.Internal.MigrateSchema.html#tryLockExpr"><span class="hs-identifier hs-var">tryLockExpr</span></a><span class="hs-special">]</span><span> </span><a href="Database.Orville.Internal.MigrateSchema.html#lockResult"><span class="hs-identifier hs-var">lockResult</span></a><span> </span><span class="hs-special">(</span><a href="Database.Orville.Internal.FromClause.html#fromClauseRaw"><span class="hs-identifier hs-var">fromClauseRaw</span></a><span> </span><span class="hs-string">&quot;&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-82"></a><span>        </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679104750"><span class="hs-identifier hs-var">locked</span></a><span>
</span><a name="line-83"></a><span>          </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679104707"><span class="hs-identifier hs-var">action</span></a><span>
</span><a name="line-84"></a><span>          </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-85"></a><span>            </span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-86"></a><span>              </span><a href="Database.Orville.Select.html#runSelect"><span class="hs-identifier hs-var">runSelect</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-87"></a><span>              </span><a href="Database.Orville.Internal.Select.html#selectQueryColumns"><span class="hs-identifier hs-var">selectQueryColumns</span></a><span>
</span><a name="line-88"></a><span>                </span><span class="hs-special">[</span><a href="Database.Orville.Internal.MigrateSchema.html#waitForLockExpr"><span class="hs-identifier hs-var">waitForLockExpr</span></a><span class="hs-special">]</span><span>
</span><a name="line-89"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-90"></a><span>                </span><span class="hs-special">(</span><a href="Database.Orville.Internal.FromClause.html#fromClauseRaw"><span class="hs-identifier hs-var">fromClauseRaw</span></a><span> </span><span class="hs-string">&quot;&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-91"></a><span>                </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-92"></a><span>            </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-93"></a><span>
</span><a name="line-94"></a><span class="hs-comment">{-|
   migrateSchema will attempt to make changes to the actual database schema
   that it it matches the provided SchemaDefinition. Unsafe migrations such as
   dropping tables or columns are never attempted unless the SchemaDefinition
   explicitly states that the items are safe to drop. Column types may be changed,
   but will fail if the database cannot successfully make the request type change.
  -}</span><span>
</span><a name="line-101"></a><span class="hs-identifier">migrateSchema</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.Internal.Monad.html#MonadOrville"><span class="hs-identifier hs-type">MonadOrville</span></a><span> </span><a href="#local-6989586621679104702"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679104703"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.Orville.Internal.Types.html#SchemaDefinition"><span class="hs-identifier hs-type">SchemaDefinition</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679104703"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-102"></a><a name="migrateSchema"><a href="Database.Orville.Internal.MigrateSchema.html#migrateSchema"><span class="hs-identifier">migrateSchema</span></a></a><span> </span><a name="local-6989586621679104751"><a href="#local-6989586621679104751"><span class="hs-identifier">schemaDef</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-103"></a><span>  </span><a href="Database.Orville.Internal.Monad.html#withConnection"><span class="hs-identifier hs-var">withConnection</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679104752"><a href="#local-6989586621679104752"><span class="hs-identifier">conn</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-104"></a><span>    </span><a href="Database.Orville.Internal.MigrateSchema.html#withLockedTransaction"><span class="hs-identifier hs-var">withLockedTransaction</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-105"></a><span>      </span><a name="local-6989586621679104753"><a href="#local-6989586621679104753"><span class="hs-identifier">plan</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.Orville.Internal.MigrateSchema.html#nonTransactionallyGenerateMigrationPlan"><span class="hs-identifier hs-var">nonTransactionallyGenerateMigrationPlan</span></a><span> </span><a href="#local-6989586621679104752"><span class="hs-identifier hs-var">conn</span></a><span> </span><a href="#local-6989586621679104751"><span class="hs-identifier hs-var">schemaDef</span></a><span>
</span><a name="line-106"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679104753"><span class="hs-identifier hs-var">plan</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-107"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-108"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679104754"><a href="#local-6989586621679104754"><span class="hs-identifier">somethingToDo</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-109"></a><span>          </span><a href="Database.Orville.Internal.MigrateSchema.html#nonTransactionallyExecuteMigrationPlan"><span class="hs-identifier hs-var">nonTransactionallyExecuteMigrationPlan</span></a><span> </span><a href="#local-6989586621679104752"><span class="hs-identifier hs-var">conn</span></a><span> </span><a href="#local-6989586621679104754"><span class="hs-identifier hs-var">somethingToDo</span></a><span>
</span><a name="line-110"></a><span>
</span><a name="line-111"></a><span class="hs-comment">{-|
   generateMigrationPlan inspects the state of the actual database schema and
   constructs a plan describing what changes would be made to make it match the
   provided SchemaDefinition. If the actual schema already matches the
   definition, Nothing will be returned.
 -}</span><span>
</span><a name="line-117"></a><span class="hs-identifier">generateMigrationPlan</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-118"></a><span>     </span><a href="Database.Orville.Internal.Monad.html#MonadOrville"><span class="hs-identifier hs-type">MonadOrville</span></a><span> </span><a href="#local-6989586621679104700"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679104701"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Database.Orville.Internal.Types.html#SchemaDefinition"><span class="hs-identifier hs-type">SchemaDefinition</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679104701"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Database.Orville.Internal.MigrationPlan.html#MigrationPlan"><span class="hs-identifier hs-type">MigrationPlan</span></a><span class="hs-special">)</span><span>
</span><a name="line-119"></a><a name="generateMigrationPlan"><a href="Database.Orville.Internal.MigrateSchema.html#generateMigrationPlan"><span class="hs-identifier">generateMigrationPlan</span></a></a><span> </span><a name="local-6989586621679104755"><a href="#local-6989586621679104755"><span class="hs-identifier">schemaDef</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-120"></a><span>  </span><a href="Database.Orville.Internal.Monad.html#withConnection"><span class="hs-identifier hs-var">withConnection</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679104756"><a href="#local-6989586621679104756"><span class="hs-identifier">conn</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-121"></a><span>    </span><a href="Database.Orville.Internal.MigrateSchema.html#withLockedTransaction"><span class="hs-identifier hs-var">withLockedTransaction</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-122"></a><span>      </span><a href="Database.Orville.Internal.MigrateSchema.html#nonTransactionallyGenerateMigrationPlan"><span class="hs-identifier hs-var">nonTransactionallyGenerateMigrationPlan</span></a><span> </span><a href="#local-6989586621679104756"><span class="hs-identifier hs-var">conn</span></a><span> </span><a href="#local-6989586621679104755"><span class="hs-identifier hs-var">schemaDef</span></a><span>
</span><a name="line-123"></a><span>
</span><a name="line-124"></a><span class="hs-identifier">nonTransactionallyGenerateMigrationPlan</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-125"></a><span>     </span><a href="Database.Orville.Internal.Monad.html#MonadOrville"><span class="hs-identifier hs-type">MonadOrville</span></a><span> </span><a href="#local-6989586621679104698"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679104699"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679104698"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.Internal.Types.html#SchemaDefinition"><span class="hs-identifier hs-type">SchemaDefinition</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679104699"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Database.Orville.Internal.MigrationPlan.html#MigrationPlan"><span class="hs-identifier hs-type">MigrationPlan</span></a><span class="hs-special">)</span><span>
</span><a name="line-126"></a><a name="nonTransactionallyGenerateMigrationPlan"><a href="Database.Orville.Internal.MigrateSchema.html#nonTransactionallyGenerateMigrationPlan"><span class="hs-identifier">nonTransactionallyGenerateMigrationPlan</span></a></a><span> </span><a name="local-6989586621679104757"><a href="#local-6989586621679104757"><span class="hs-identifier">conn</span></a></a><span> </span><a name="local-6989586621679104758"><a href="#local-6989586621679104758"><span class="hs-identifier">schemaDef</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-127"></a><span>  </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Database.Orville.Internal.MigrateSchema.html#buildMigrationPlan"><span class="hs-identifier hs-var">buildMigrationPlan</span></a><span> </span><a href="#local-6989586621679104758"><span class="hs-identifier hs-var">schemaDef</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Database.Orville.Internal.SchemaState.html#loadSchemaState"><span class="hs-identifier hs-var">loadSchemaState</span></a><span> </span><a href="#local-6989586621679104757"><span class="hs-identifier hs-var">conn</span></a><span>
</span><a name="line-128"></a><span>
</span><a name="line-129"></a><span class="hs-identifier">nonTransactionallyExecuteMigrationPlan</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-130"></a><span>     </span><a href="Database.Orville.Internal.Monad.html#MonadOrville"><span class="hs-identifier hs-type">MonadOrville</span></a><span> </span><a href="#local-6989586621679104696"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679104697"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679104696"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.Internal.MigrationPlan.html#MigrationPlan"><span class="hs-identifier hs-type">MigrationPlan</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679104697"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-131"></a><a name="nonTransactionallyExecuteMigrationPlan"><a href="Database.Orville.Internal.MigrateSchema.html#nonTransactionallyExecuteMigrationPlan"><span class="hs-identifier">nonTransactionallyExecuteMigrationPlan</span></a></a><span> </span><a name="local-6989586621679104759"><a href="#local-6989586621679104759"><span class="hs-identifier">conn</span></a></a><span> </span><a name="local-6989586621679104760"><a href="#local-6989586621679104760"><span class="hs-identifier">plan</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-132"></a><span>  </span><span class="hs-identifier hs-var">forM_</span><span> </span><span class="hs-special">(</span><a href="Database.Orville.Internal.MigrationPlan.html#migrationPlanItems"><span class="hs-identifier hs-var">migrationPlanItems</span></a><span> </span><a href="#local-6989586621679104760"><span class="hs-identifier hs-var">plan</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a href="Database.Orville.Internal.MigrationPlan.html#MigrationItem"><span class="hs-identifier hs-var">MigrationItem</span></a><span> </span><a name="local-6989586621679104761"><a href="#local-6989586621679104761"><span class="hs-identifier">schemaItem</span></a></a><span> </span><a name="local-6989586621679104762"><a href="#local-6989586621679104762"><span class="hs-identifier">ddl</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-133"></a><span>    </span><a href="Database.Orville.Internal.Execute.html#executingSql"><span class="hs-identifier hs-var">executingSql</span></a><span> </span><a href="Database.Orville.Internal.Monad.html#DDLQuery"><span class="hs-identifier hs-var">DDLQuery</span></a><span> </span><a href="#local-6989586621679104762"><span class="hs-identifier hs-var">ddl</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-134"></a><span>      </span><a name="local-6989586621679104763"><a href="#local-6989586621679104763"><span class="hs-identifier">stmt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">prepare</span><span> </span><a href="#local-6989586621679104759"><span class="hs-identifier hs-var">conn</span></a><span> </span><a href="#local-6989586621679104762"><span class="hs-identifier hs-var">ddl</span></a><span>
</span><a name="line-135"></a><span>      </span><span class="hs-identifier">executeRaw</span><span> </span><a href="#local-6989586621679104763"><span class="hs-identifier hs-var">stmt</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Exc</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">catch</span><span class="hs-special">`</span><span>
</span><a name="line-136"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Exc</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">throw</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Database.Orville.Internal.MigrationError.html#MigrationExecutionError"><span class="hs-identifier hs-var">MigrationExecutionError</span></a><span> </span><a href="#local-6989586621679104761"><span class="hs-identifier hs-var">schemaItem</span></a><span class="hs-special">)</span><span>
</span><a name="line-137"></a><span>
</span><a name="line-138"></a><span class="hs-identifier">buildMigrationPlan</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Database.Orville.Internal.Types.html#SchemaDefinition"><span class="hs-identifier hs-type">SchemaDefinition</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.Internal.SchemaState.html#SchemaState"><span class="hs-identifier hs-type">SchemaState</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Database.Orville.Internal.MigrationPlan.html#MigrationPlan"><span class="hs-identifier hs-type">MigrationPlan</span></a><span>
</span><a name="line-139"></a><a name="buildMigrationPlan"><a href="Database.Orville.Internal.MigrateSchema.html#buildMigrationPlan"><span class="hs-identifier">buildMigrationPlan</span></a></a><span> </span><a name="local-6989586621679104764"><a href="#local-6989586621679104764"><span class="hs-identifier">schemaDef</span></a></a><span> </span><a name="local-6989586621679104765"><a href="#local-6989586621679104765"><span class="hs-identifier">schemaState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldMap</span><span> </span><a href="#local-6989586621679104766"><span class="hs-identifier hs-var">mkPlan</span></a><span> </span><a href="#local-6989586621679104764"><span class="hs-identifier hs-var">schemaDef</span></a><span>
</span><a name="line-140"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-141"></a><span>    </span><a name="local-6989586621679104766"><a href="#local-6989586621679104766"><span class="hs-identifier">mkPlan</span></a></a><span> </span><a name="local-6989586621679104767"><a href="#local-6989586621679104767"><span class="hs-identifier">element</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-142"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679104767"><span class="hs-identifier hs-var">element</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-143"></a><span>        </span><a href="Database.Orville.Internal.Types.html#Table"><span class="hs-identifier hs-var">Table</span></a><span> </span><a name="local-6989586621679104768"><a href="#local-6989586621679104768"><span class="hs-identifier">tableDef</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.Internal.MigrateTable.html#migrateTablePlan"><span class="hs-identifier hs-var">migrateTablePlan</span></a><span> </span><a href="#local-6989586621679104768"><span class="hs-identifier hs-var">tableDef</span></a><span> </span><a href="#local-6989586621679104765"><span class="hs-identifier hs-var">schemaState</span></a><span>
</span><a name="line-144"></a><span>        </span><a href="Database.Orville.Internal.Types.html#DropTable"><span class="hs-identifier hs-var">DropTable</span></a><span> </span><a name="local-6989586621679104769"><a href="#local-6989586621679104769"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.Internal.MigrateTable.html#dropTablePlan"><span class="hs-identifier hs-var">dropTablePlan</span></a><span> </span><a href="#local-6989586621679104769"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679104765"><span class="hs-identifier hs-var">schemaState</span></a><span>
</span><a name="line-145"></a><span>        </span><a href="Database.Orville.Internal.Types.html#Index"><span class="hs-identifier hs-var">Index</span></a><span> </span><a name="local-6989586621679104770"><a href="#local-6989586621679104770"><span class="hs-identifier">indexDef</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.Internal.MigrateIndex.html#createIndexPlan"><span class="hs-identifier hs-var">createIndexPlan</span></a><span> </span><a href="#local-6989586621679104770"><span class="hs-identifier hs-var">indexDef</span></a><span> </span><a href="#local-6989586621679104765"><span class="hs-identifier hs-var">schemaState</span></a><span>
</span><a name="line-146"></a><span>        </span><a href="Database.Orville.Internal.Types.html#DropIndex"><span class="hs-identifier hs-var">DropIndex</span></a><span> </span><a name="local-6989586621679104771"><a href="#local-6989586621679104771"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Database.Orville.Internal.MigrateIndex.html#dropIndexPlan"><span class="hs-identifier hs-var">dropIndexPlan</span></a><span> </span><a href="#local-6989586621679104771"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679104765"><span class="hs-identifier hs-var">schemaState</span></a><span>
</span><a name="line-147"></a><span>        </span><a href="Database.Orville.Internal.Types.html#Constraint"><span class="hs-identifier hs-var">Constraint</span></a><span> </span><a name="local-6989586621679104772"><a href="#local-6989586621679104772"><span class="hs-identifier">constraintDef</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-148"></a><span>          </span><a href="Database.Orville.Internal.MigrateConstraint.html#createConstraintPlan"><span class="hs-identifier hs-var">createConstraintPlan</span></a><span> </span><a href="#local-6989586621679104772"><span class="hs-identifier hs-var">constraintDef</span></a><span> </span><a href="#local-6989586621679104765"><span class="hs-identifier hs-var">schemaState</span></a><span>
</span><a name="line-149"></a><span>        </span><a href="Database.Orville.Internal.Types.html#DropConstraint"><span class="hs-identifier hs-var">DropConstraint</span></a><span> </span><a name="local-6989586621679104773"><a href="#local-6989586621679104773"><span class="hs-identifier">tablName</span></a></a><span> </span><a name="local-6989586621679104774"><a href="#local-6989586621679104774"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-150"></a><span>          </span><a href="Database.Orville.Internal.MigrateConstraint.html#dropConstraintPlan"><span class="hs-identifier hs-var">dropConstraintPlan</span></a><span> </span><a href="#local-6989586621679104773"><span class="hs-identifier hs-var">tablName</span></a><span> </span><a href="#local-6989586621679104774"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679104765"><span class="hs-identifier hs-var">schemaState</span></a><span>
</span><a name="line-151"></a></pre></body></html>